var Chat={page:1,toUser:"",init:function(){let e=getQueryVariable("toUser");""!==(Chat.toUser=e)&&($.ajax({url:Label.servePath+"/chat/mark-as-read?apiKey="+apiKey+"&fromUser="+Chat.toUser,type:"GET"}),"FileTransfer"!==e&&$.ajax({url:Label.servePath+"/user/"+e,type:"GET",success:function(e){-1===e.code&&(alert("指定的用户名不存在，请检查后重试！"),location.href=Label.servePath+"/chat"),Chat.addToMessageList(e.userName,e.userAvatarURL,"&nbsp;")}})),setTimeout(function(){$.ajax({url:Label.servePath+"/chat/get-list?apiKey="+apiKey,type:"GET",success:function(a){if(0===a.result){let e=a.data;e.forEach(e=>{"文件传输助手"===e.receiverUserName?$("#fileTransferMsg").html(e.preview):e.senderUserName!=Label.currentUserName?$("#chatTo"+e.senderUserName).length<=0&&Chat.addToMessageList(e.senderUserName,e.senderAvatar,e.preview):$("#chatTo"+e.receiverUserName).length<=0&&Chat.addToMessageList(e.receiverUserName,e.receiverAvatar,e.preview)})}}})},100),$(function(){setTimeout(function(){$.ajax({url:Label.servePath+"/chat/has-unread?apiKey="+apiKey,type:"GET",success:function(e){e.result;let a=e.data;a.forEach(e=>{console.log(e.senderUserName),$("#chatTo"+e.senderUserName).css("background-color","#fff4eb")})}})},200)}),""===e?($("#chatStatus").html('请在左侧列表选择最近聊天的成员，或直接发起聊天。<br><br><input class="form" id="chatWithInput" placeholder="输入用户名">&nbsp;<button onclick="Chat.startAChat()">发起聊天</button>'),$("#chatWithInput").keypress(function(e){13==e.which&&Chat.startAChat()})):($("#chatStatus").html('和 <a href="'+Label.servePath+"/member/"+e+'">'+e+"</a> 聊天中"),$("#buttons").show(),$(".pagination__chat").show(),$("#sendChatBtn").on("click",function(){Chat.send()}),Chat.editor=Util.newVditor({id:"messageContent",cache:!0,preview:{mode:"editor"},resize:{enable:!0,position:"bottom"},height:150,placeholder:"说点什么吧，友善第一哦。",toolbar:["emoji","link","upload","edit-mode",{name:"more",toolbar:["insert-after","fullscreen","preview","info","help"]}],ctrlEnter:function(){Chat.send()}}),Chat.ws=new WebSocket(chatChannelURL+e),Chat.ws.onopen=function(){console.log("Connected to chat channel websocket.")},Chat.ws.onmessage=function(e){var a,t,s,r,n,i,l,o=JSON.parse(e.data);-1===o.code?$("#chatContentTip").addClass("error").html("<ul><li>"+o.msg+"</li></ul>"):($("#chatContentTip").removeClass("error succ").html(""),a=o.oId,o.toId,o.fromId,t=o.time,s=o.content,r=o.preview.substring(0,10),n=10<o.preview.length?"...":"",o.user_session,i=o.senderUserName,l=o.senderAvatar,e=o.receiverUserName,o.receiverAvatar,i===Label.currentUserName?(Chat.addSelfMsg(a,i,l,s,t,!1),$("#chatTo"+e).find("span").html(r+n)):(Chat.addTargetMsg(a,i,l,s,t,!1),$("#chatTo"+i).find("span").html(r+n)))},Chat.ws.onclose=function(){console.log("Disconnected to chat channel websocket."),setInterval(function(){$.ajax({url:Label.servePath+"/shop",method:"get",success:function(){location.reload()}})},1e4)},Chat.ws.onerror=function(e){console.log("ERROR",e),setInterval(function(){$.ajax({url:Label.servePath+"/shop",method:"get",success:function(){location.reload()}})},1e4)},$(function(){setTimeout(function(){$("#chatTo"+e).css("background-color","#f1f1f1")},220)}),Chat.loadMore(),$(window).scroll(function(){var e=$(this).scrollTop();$(document).height()<=e+$(this).height()+500&&Chat.loadMore()}))},startAChat(){var e=$("#chatWithInput").val();""!==e&&(location.href=Label.servePath+"/chat?toUser="+e)},noMore:!1,loadMore(){Chat.noMore||$.ajax({url:Label.servePath+"/chat/get-message?apiKey="+apiKey+"&toUser="+Chat.toUser+"&page="+Chat.page+"&pageSize=20",type:"GET",success:function(e){try{e.data.length}catch(e){Chat.noMore=!0}Chat.noMore||(Chat.page++,e.data.forEach(e=>{var a=e.oId,t=(e.toId,e.fromId,e.time),s=e.content,r=(e.preview.substring(0,10),e.preview.length,e.user_session,e.senderUserName),n=e.senderAvatar;e.receiverUserName,e.receiverAvatar;r===Label.currentUserName?Chat.addSelfMsg(a,r,n,s,t,!0):Chat.addTargetMsg(a,r,n,s,t,!0)}))}})},send(){var e=Chat.editor.getValue();1024<e.length?$("#chatContentTip").addClass("error").html("<ul><li>发送失败：超过 1024 字符，请修改后重试。</li></ul>"):(Chat.ws.send(e),Chat.editor.setValue(""))},addToMessageList(e,a,t){var s=10<t.length?"...":"";$("#chatMessageList").append('<div class="module-panel" id="chatTo'+e+'" style="padding: 10px 15px;cursor: pointer" onclick="location.href = Label.servePath + \'/chat?toUser='+e+'\'"\n    <nav class="home-menu">\n        <div class="avatar"\n             style="display: inline-block; background-image:url('+a+')">\n        </div>\n        <div style="display: inline-block; vertical-align: -12px;">\n            '+e+'<br>\n            <span style="color: #868888">'+t.substring(0,10)+s+"</span>\n        </div>\n    </nav>\n</div>")},addSelfMsg(e,a,t,s,r,n){!0===n?$("#chats").append('<div id="chat'+e+'" class="fn__flex chats__item chats__item--me">\n    <a href="'+Label.servePath+"/member/"+a+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+a+'"\n             style="background-image: url('+t+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+r+"\n        </div>\n    </div>\n</div>"):$("#chats").prepend('<div id="chat'+e+'" class="fn__flex chats__item chats__item--me">\n    <a href="'+Label.servePath+"/member/"+a+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+a+'"\n             style="background-image: url('+t+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+r+"\n        </div>\n    </div>\n</div>"),Util.listenUserCard()},addTargetMsg(e,a,t,s,r,n){!0===n?$("#chats").append('<div id="chat'+e+'" class="fn__flex chats__item">\n    <a href="'+Label.servePath+"/member/"+a+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+a+'"\n             style="background-image: url('+t+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+r+"\n        </div>\n    </div>\n</div>"):$("#chats").prepend('<div id="chat'+e+'" class="fn__flex chats__item">\n    <a href="'+Label.servePath+"/member/"+a+'" style="height: 38px">\n        <div class="avatar tooltipped__user" aria-label="'+a+'"\n             style="background-image: url('+t+');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n        <div style="margin-top: 4px" class="vditor-reset ft__smaller ">\n            '+s+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right date-bar">\n            '+r+"\n        </div>\n    </div>\n</div>"),Util.listenUserCard()}};function getQueryVariable(e){for(var a=window.location.search.substring(1).split("&"),t=0;t<a.length;t++){var s=a[t].split("=");if(s[0]==e)return s[1]}return""}$(document).ready(function(){Chat.init()});