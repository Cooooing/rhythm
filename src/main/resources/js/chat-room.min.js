var ChatRoom={init:function(){if(0===$("#chatContent").length)return!1;ChatRoom.editor=Util.newVditor({id:"chatContent",cache:!0,preview:{mode:"editor"},resize:{enable:!0,position:"bottom"},toolbar:["emoji","headings","bold","italic","link","|","list","ordered-list","check","outdent","indent","|","quote","code","insert-before","insert-after","|","upload","table","|","undo","redo","|",{name:"more",toolbar:["fullscreen","edit-mode","both","preview","outline","content-theme","code-theme","devtools","info","help"]}],height:200,counter:40960,placeholder:"聊天室历史记录将永久保存，每天一次撤回机会；在发送消息前请三思而后行，友善是第一原则。",ctrlEnter:function(){ChatRoom.send()}});var t=null;$(".chat-room").on("dblclick",".vditor-reset img",function(){clearTimeout(t),$(this).hasClass("emoji")||window.open($(this).attr("src"))}).on("click",".vditor-reset img",function(e){var a,o;clearTimeout(t),$(this).hasClass("emoji")||(a=$(this),o=this,t=setTimeout(function(){var e=o.offsetTop,t=o.offsetLeft;$("body").append('<div class="img-preview" onclick="$(this).remove()"><img style="transform: translate3d('+Math.max(0,t)+"px, "+Math.max(0,e-$(window).scrollTop())+'px, 0)" src="'+a.attr("src").split("?imageView2")[0]+'"></div>'),$(".img-preview").css({"background-color":"#fff",position:"fixed"})},100))})},send:function(){var e=ChatRoom.editor.getValue();$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify({content:e}),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3")},success:function(e){0===e.code?($("#chatContentTip").removeClass("error succ").html(""),ChatRoom.editor.setValue("")):$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")},complete:function(e,t){$(".form button.red").removeAttr("disabled").css("opacity","1")}})},more:function(){page++,$.ajax({url:Label.servePath+"/chat-room/more?page="+page,type:"GET",cache:!1,async:!1,success:function(e){if(0!==e.data.length){for(var t in e.data){t=e.data[t],t=ChatRoom.renderMessage(t.userNickname,t.userName,t.userAvatarURL,t.time,t.content,t.oId,Label.currentUser,Label.level3Permitted);$("#chats").append(t),$("#chats>div.fn-none").show(200),$("#chats>div.fn-none").removeClass("fn-none"),ChatRoom.resetMoreBtnListen()}Util.listenUserCard()}else $("#more").removeAttr("onclick"),$("#more").html("已经到底啦！")}})},resetMoreBtnListen:function(){$("body").not("details-menu").click(function(){$("details[open]").removeAttr("open")})},revoke:function(e){$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){e.code,Util.alert(e.msg)}})},at:function(e,a,t){if(!0===t){t=ChatRoom.editor.getValue();"\n"!==t?ChatRoom.editor.setValue("@"+e+"  : "+t):ChatRoom.editor.setValue("@"+e+"  : ")}else{let t="";$.ajax({url:Label.servePath+"/cr/raw/"+a,method:"get",async:!1,success:function(e){t=e.replace(/(<!--).*/g,""),t=t.replace(/\n/g,"\n> ")}});a=ChatRoom.editor.getValue();"\n"!==a?ChatRoom.editor.setValue("@"+e+"  引用：\n> "+t+"\n并说："+a):ChatRoom.editor.setValue("@"+e+"  引用：\n> "+t+"\n并说：")}ChatRoom.editor.focus()},renderMessage:function(e,t,a,o,n,s,i,r){let l="",c="";e=void 0!==e&&""!==e?e+" ("+t+")":t,i===t&&(l=" chats__item--me",c='<a onclick="ChatRoom.revoke('+s+')" class="item">撤回</a>\n'),r&&(c='<a onclick="ChatRoom.revoke('+s+')" class="item">撤回 (使用管理员权限)</a>\n');let d='<div class="fn-none">';return d+='<div id="chatroom'+s+'" class="fn__flex chats__item'+l+'">\n    <a href="/member/'+t+'">\n        <div class="avatar tooltipped__user" aria-label="'+t+'" style="background-image: url(\''+a+'\');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n',i!==t&&(d+='<div class="ft__fade ft__smaller" style="padding-bottom: 3px;border-bottom: 1px solid #eee">\n    <span class="ft-gray">'+e+"</span>\n</div>"),d+='        <div style="margin-top: 4px" class="vditor-reset ft__smaller '+Label.chatRoomPictureStatus+'">\n            '+n+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right">\n            '+o+'\n                <span class="fn__space5"></span>\n                <details class="details action__item fn__flex-center">\n                    <summary>\n                        ···\n                    </summary>\n                    <details-menu class="fn__layer">\n                        <a onclick="ChatRoom.at(\''+t+"', '"+s+'\', true)" class="item">@'+t+"</a>\n                        <a onclick=\"ChatRoom.at('"+t+"', '"+s+'\', false)" class="item">引用</a>\n'+c+"                    </details-menu>\n                </details>\n        </div>\n    </div>\n</div></div>",d}};