var ChatRoom={init:function(){if(0===$("#chatContent").length)return!1;ChatRoom.editor=Util.newVditor({id:"chatContent",cache:!0,preview:{mode:"editor"},resize:{enable:!0,position:"bottom"},toolbar:["emoji","headings","bold","italic","link","|","list","ordered-list","check","outdent","indent","|","quote","code","insert-before","insert-after","|","upload","table","|","undo","redo","|",{name:"more",toolbar:["fullscreen","edit-mode","both","preview","outline","content-theme","code-theme","devtools","info","help"]}],height:200,counter:40960,placeholder:"聊天室历史记录将永久保存，每天一次撤回机会；在发送消息前请三思而后行，友善是第一原则。",ctrlEnter:function(){ChatRoom.send()}});var t=null;$(".chat-room").on("dblclick",".vditor-reset img",function(){clearTimeout(t),$(this).hasClass("emoji")||window.open($(this).attr("src"))}).on("click",".vditor-reset img",function(e){var a,n;clearTimeout(t),$(this).hasClass("emoji")||(a=$(this),n=this,t=setTimeout(function(){var e=n.offsetTop,t=n.offsetLeft;$("body").append('<div class="img-preview" onclick="$(this).remove()"><img style="transform: translate3d('+Math.max(0,t)+"px, "+Math.max(0,e-$(window).scrollTop())+'px, 0)" src="'+a.attr("src").split("?imageView2")[0]+'"></div>'),$(".img-preview").css({"background-color":"#fff",position:"fixed"})},100))}),$("#redPacketBtn").on("click",function(){Util.alert('<div class="form fn__flex-column">\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">积分</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="1" max="20000" required="" value="32" id="redPacketMoney" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">个数</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="number" min="1" max="1000" required="" value="2" id="redPacketCount" onkeypress="return(/[\\d]/.test(String.fromCharCode(event.keyCode)))">\n</label>\n<label>\n  <div class="ft__smaller ft__fade" style="float: left">留言</div>\n  <div class="fn-hr5 fn__5"></div>\n  <input type="text" id="redPacketMsg" placeholder="摸鱼者，事竟成！" maxlength="20">\n</label>\n<div class="fn-hr5"></div>\n<div class="fn__flex" style="margin-top: 15px">\n  <div class="fn__flex-1 fn__flex-center" style="text-align: left;">总计：<span id="redPacketAmount">32</span> 积分</div>\n  <button class="btn btn--confirm" id="redPacketConfirm">发送</button>\n</div>\n</div>',"发红包"),$("#redPacketMoney").unbind(),$("#redPacketCount").unbind(),$("#redPacketMoney").on("change",function(){""===$("#redPacketMoney").val()&&$("#redPacketMoney").val("0"),2e4<$("#redPacketMoney").val()&&$("#redPacketMoney").val("20000"),$("#redPacketMoney").val()<=0&&$("#redPacketMoney").val("1"),$("#redPacketAmount").text($("#redPacketMoney").val())}),$("#redPacketCount").on("change",function(){1e3<$("#redPacketCount").val()&&$("#redPacketCount").val("1000"),$("#redPacketCount").val()<=0&&$("#redPacketCount").val("1")}),$("#redPacketConfirm").on("click",function(){var e=$("#redPacketMoney").val(),t=$("#redPacketCount").val();let a=$("#redPacketMsg").val();""===a&&(a="摸鱼者，事竟成！");t={money:e,count:t,msg:a},t={content:"[redpacket]"+JSON.stringify(t)+"[/redpacket]"};$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify(t),success:function(e){0!==e.code&&$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")}}),Util.closeAlert()})})},send:function(){var e=ChatRoom.editor.getValue();$.ajax({url:Label.servePath+"/chat-room/send",type:"POST",cache:!1,data:JSON.stringify({content:e}),beforeSend:function(){$(".form button.red").attr("disabled","disabled").css("opacity","0.3")},success:function(e){0===e.code?($("#chatContentTip").removeClass("error succ").html(""),ChatRoom.editor.setValue("")):$("#chatContentTip").addClass("error").html("<ul><li>"+e.msg+"</li></ul>")},error:function(e){$("#chatContentTip").addClass("error").html("<ul><li>"+e.statusText+"</li></ul>")},complete:function(e,t){$(".form button.red").removeAttr("disabled").css("opacity","1")}})},more:function(){page++,$.ajax({url:Label.servePath+"/chat-room/more?page="+page,type:"GET",cache:!1,async:!1,success:function(e){if(0!==e.data.length){for(var t in e.data){t=e.data[t],t=ChatRoom.renderMessage(t.userNickname,t.userName,t.userAvatarURL,t.time,t.content,t.oId,Label.currentUser,Label.level3Permitted);$("#chats").append(t),$("#chats>div.fn-none").show(200),$("#chats>div.fn-none").removeClass("fn-none"),ChatRoom.resetMoreBtnListen()}Util.listenUserCard()}else $("#more").removeAttr("onclick"),$("#more").html("已经到底啦！")}})},resetMoreBtnListen:function(){$("body").not("details-menu").click(function(){$("details[open]").removeAttr("open")})},revoke:function(e){$.ajax({url:Label.servePath+"/chat-room/revoke/"+e,type:"DELETE",cache:!1,success:function(e){e.code,Util.alert(e.msg)}})},at:function(e,a,t){if(!0===t){t=ChatRoom.editor.getValue();"\n"!==t?ChatRoom.editor.setValue("@"+e+"  : "+t):ChatRoom.editor.setValue("@"+e+"  : ")}else{let t="";$.ajax({url:Label.servePath+"/cr/raw/"+a,method:"get",async:!1,success:function(e){t=e.replace(/(<!--).*/g,""),t=t.replace(/\n/g,"\n> ")}});a=ChatRoom.editor.getValue();"\n"!==a?ChatRoom.editor.setValue("@"+e+"  引用：\n> "+t+"\n并说："+a):ChatRoom.editor.setValue("@"+e+"  引用：\n> "+t+"\n并说：")}ChatRoom.editor.focus()},unpackRedPacket:function(e){$.ajax({url:Label.servePath+"/chat-room/red-packet/open",method:"POST",data:JSON.stringify({oId:e}),success:function(e){let a="没抢到，下次手速快一点哦",n="";var o=e.who;for(let e=0;e<o.length;e++){var r=o[e],s=r.userMoney,i=r.userName;i===Label.currentUser&&(a="抢到了 "+s+" 积分");var l=r.time;let t;$.ajax({url:Label.servePath+"/user/"+i,type:"GET",cache:!1,async:!1,headers:{csrfToken:Label.csrfToken},success:function(e){t=e}});r=t.userAvatarURL;n+='            <li class="fn__flex menu__item">\n                <img class="avatar avatar--mid" style="margin-right: 10px; background-image: none; background-color: transparent;" src="'+r+'">\n                <div class="fn__flex-1" style="text-align: left !important;">\n                    <h2 class="list__user"><a href="'+Label.servePath+"/member/"+i+'">'+i+'</a></h2>\n                    <span class="ft__fade ft__smaller">'+l+'</span>\n                </div>\n                <div class="fn__flex-center">'+s+" 积分</div>\n            </li>\n"}Util.alert('<style>.dialog-header-bg {border-radius: 4px 4px 0px 0px; background-color: rgb(210, 63, 49); color: rgb(255, 255, 255);}.dialog-main {height: 456px;overflow: auto;}</style><div class="fn-hr5"></div>\n<div class="fn-hr5"></div>\n<div class="fn-hr5"></div>\n<div class="fn-hr5"></div>\n<div class="ft__center">\n    <div class="fn__flex-inline">\n        <img class="avatar avatar--small" src="'+e.info.userAvatarURL+'" style="background-image: none; background-color: transparent; width: 20px; height: 20px; margin-right: 0px;">\n        <div class="fn__space5"></div>\n        <a href="'+Label.servePath+"/member/"+e.info.userName+'">'+e.info.userName+'</a>\'s 红包\n    </div>\n    <div class="fn-hr5"></div>\n    <div class="ft__smaller ft__fade">\n'+e.info.msg+'\n    </div>\n    <div class="hongbao__count">\n'+a+'\n    </div>\n    <div class="ft__smaller ft__fade">总计 '+e.info.got+"/"+e.info.count+'</div>\n</div>\n\n<div class="list"><ul>\n'+n+"</ul></div>","红包")},error:function(e){Util.alert(e.msg)}})},renderMessage:function(e,t,a,n,o,r,s,i){let l=!1;try{var c=$.parseJSON(o.replace("<p>","").replace("</p>",""));"redPacket"===c.msgType&&(l=!0,o='<div class="hongbao__item fn__flex-inline" onclick="ChatRoom.unpackRedPacket(\''+r+'\')">\n    <svg class="ft__red hongbao__icon">\n        <use xlink:href="#redPacketIcon"></use>\n    </svg>\n    <div>\n        <div>'+c.msg+'</div>\n        <div class="ft__smaller ft__fade">\n        </div>\n    </div>\n</div>')}catch(e){}let d="",f="";e=void 0!==e&&""!==e?e+" ("+t+")":t,s===t&&(d=" chats__item--me",f='<a onclick="ChatRoom.revoke('+r+')" class="item">撤回</a>\n'),i&&(f='<a onclick="ChatRoom.revoke('+r+')" class="item">撤回 (使用管理员权限)</a>\n');let m='<div class="fn-none">';return m+='<div id="chatroom'+r+'" class="fn__flex chats__item'+d+'">\n    <a href="/member/'+t+'">\n        <div class="avatar tooltipped__user" aria-label="'+t+'" style="background-image: url(\''+a+'\');"></div>\n    </a>\n    <div class="chats__content">\n        <div class="chats__arrow"></div>\n',s!==t&&(m+='<div class="ft__fade ft__smaller" style="padding-bottom: 3px;border-bottom: 1px solid #eee">\n    <span class="ft-gray">'+e+"</span>\n</div>"),m+='        <div style="margin-top: 4px" class="vditor-reset ft__smaller '+Label.chatRoomPictureStatus+'">\n            '+o+'\n        </div>\n        <div class="ft__smaller ft__fade fn__right">\n            '+n+'\n                <span class="fn__space5"></span>\n',l||(m+='                <details class="details action__item fn__flex-center">\n                    <summary>\n                        ···\n                    </summary>\n                    <details-menu class="fn__layer">\n                        <a onclick="ChatRoom.at(\''+t+"', '"+r+'\', true)" class="item">@'+t+"</a>\n                        <a onclick=\"ChatRoom.at('"+t+"', '"+r+'\', false)" class="item">引用</a>\n'+f+"                    </details-menu>\n                </details>\n"),m+="        </div>\n    </div>\n</div></div>",m}};